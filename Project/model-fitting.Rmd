---
title: "model fitting"
author: "shahaf"
date: "2024-06-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, message=FALSE, include=FALSE}
library(knitr)
library(tidyverse)
library(broom)
library(htmltools)
library(janitor)
library(kableExtra)
library(dplyr)
library(car)
library(infer)
library(boot)
```

```{r, include=FALSE}
VacantApt <- read.csv("../data/Updated/vacant_apartments.csv")
PropertiesRooms <- read.csv("../data/Updated/properties_by_rooms.csv")
Purchases <- read.csv("../data/Updated/property_purchases.csv")

Kneset20 <- read.csv("../data/Updated/Kneset20_summed.csv")
Kneset21 <- read.csv("../data/Updated/Kneset21_summed.csv")
Kneset22 <- read.csv("../data/Updated/Kneset22_summed.csv")
Kneset23 <- read.csv("../data/Updated/Kneset23_summed.csv")
Kneset24 <- read.csv("../data/Updated/Kneset24_summed.csv")
Kneset25 <- read.csv("../data/Updated/Kneset25_summed.csv")
```


```{r, include=FALSE}
VacantApt
PropertiesRooms
Purchases
```


```{r, include=FALSE}
Kneset20
Kneset21
Kneset22
Kneset23
Kneset24
Kneset25
```


```{r, include=FALSE}
PropertiesRooms <- drop_na(PropertiesRooms) # 4 apartments who add no floor data was removed
# replacing NA's with 0's when there where no apartment purchased.
Purchases <- Purchases %>%
  mutate(
    X3.rooms.apartments = ifelse(is.na(X3.rooms.apartments), 0, X3.rooms.apartments),
    X4..rooms.apartments = ifelse(is.na(X4..rooms.apartments), 0, X4..rooms.apartments),
    average.price..NIS..3.rooms.apartments = ifelse(is.na(average.price..NIS..3.rooms.apartments), 0, average.price..NIS..3.rooms.apartments),
    average.price..NIS..4..rooms.apartments = ifelse(is.na(average.price..NIS..4..rooms.apartments), 0, average.price..NIS..4..rooms.apartments)
  )

Purchases <- Purchases %>% clean_names()
Purchases
```



```{r, include=FALSE}
# filter purchuses by year and join with relevant elections csv
Joined_Purch_Kneset20 <- Purchases %>%
  filter(year < 2019) %>%
  left_join(Kneset20, by = c("lamas_code" = "Lamas_code"))

Joined_Purch_Kneset21 <- Purchases %>%
  filter(year == 2019) %>%
  left_join(Kneset21, by = c("lamas_code" = "Lamas_code"))

Joined_Purch_Kneset22 <- Purchases %>%
  filter(year == 2020) %>%
  left_join(Kneset22, by = c("lamas_code" = "Lamas_code"))

Joined_Purch_Kneset23 <- Purchases %>%
  filter(year == 2021) %>%
  left_join(Kneset23, by = c("lamas_code" = "Lamas_code"))

Joined_Purch_Kneset24 <- Purchases %>%
  filter(year == 2022) %>%
  left_join(Kneset24, by = c("lamas_code" = "Lamas_code"))

Joined_Purch_Kneset25 <- Purchases %>%
  filter(year > 2022) %>%
  left_join(Kneset25, by = c("lamas_code" = "Lamas_code"))

# combining results
Purchuses_Elections <- bind_rows(Joined_Purch_Kneset20, Joined_Purch_Kneset21, Joined_Purch_Kneset22, Joined_Purch_Kneset23, Joined_Purch_Kneset24, Joined_Purch_Kneset25)
```


```{r}
Purchuses_Elections <- Purchuses_Elections %>%
  mutate(
    x3_average_paid_in_Mil = (x3_rooms_apartments * average_price_nis_3_rooms_apartments) / 1000000,
    x4_average_paid_in_Mil = (x4_rooms_apartments * average_price_nis_4_rooms_apartments) / 1000000,
    total_paid_in_Mil = x3_average_paid_in_Mil + x4_average_paid_in_Mil,
    sum_apartments = x3_rooms_apartments + x4_rooms_apartments
  )
```



```{r}
# selecting relevant columns
Purchuses_Elections <- Purchuses_Elections %>%
  dplyr::select(lamas_name, year, x3_rooms_apartments, x4_rooms_apartments, x3_average_paid_in_Mil, x4_average_paid_in_Mil, sum_apartments, total_paid_in_Mil, BZB, first.party, second.party, third.party, forth.party, first.party.percentage, second.party.percentage, third.party.percentage, forth.party.percentage, coalition.support)

# Fix party name
Purchuses_Elections <- Purchuses_Elections %>%
  mutate(
    first.party = case_when(
    first.party == "Kahul_lavan" ~ "Kahul_Lavan",
    first.party == "Yahadut_Hator" ~ "Yahadut_Hatora",
    first.party == "Israel_beitenu" ~ "Israel_Beitenu",
    first.party == "Zionot_datit" ~ "Tsionot_Datit",
    TRUE ~ first.party
    ),
    second.party = case_when(
    second.party == "Kahul_lavan" ~ "Kahul_Lavan",
    second.party == "Yahadut_Hator" ~ "Yahadut_Hatora",
    second.party == "Israel_beitenu" ~ "Israel_Beitenu",
    second.party == "Zionot_datit" ~ "Tsionot_Datit",
    TRUE ~ second.party
    ),
    third.party = case_when(
    third.party == "Kahul_lavan" ~ "Kahul_Lavan",
    third.party == "Yahadut_Hator" ~ "Yahadut_Hatora",
    third.party == "Israel_beitenu" ~ "Israel_Beitenu",
    third.party == "Zionot_datit" ~ "Tsionot_Datit",
    TRUE ~ third.party
    ),
    forth.party = case_when(
    forth.party == "Kahul_lavan" ~ "Kahul_Lavan",
    forth.party == "Yahadut_Hator" ~ "Yahadut_Hatora",
    forth.party == "Israel_beitenu" ~ "Israel_Beitenu",
    forth.party == "Zionot_datit" ~ "Tsionot_Datit",
    TRUE ~ forth.party
    )
  )

# apply factor
Purchuses_Elections <- Purchuses_Elections %>%
  mutate(
    first.party = as.factor(first.party),
    second.party = as.factor(second.party),
    third.party = as.factor(third.party),
    forth.party = as.factor(forth.party),
    )

```


```{r, include=FALSE}
PropertiesRooms <- PropertiesRooms %>%
  mutate(
    Total_Rooms = NoRooms + OneRooms + TwoRooms + ThreeRooms + FourRooms + FiveRooms + SixRooms + SevenRooms + EightRooms + NineRooms + TenRooms + MoreRooms
  )
PropertiesRooms
```


```{r}
# Group by lamas_code and sum Total_Rooms for each city in PropertiesRooms
PropertiesRooms_Summary <- PropertiesRooms %>%
  group_by(lamas_code, CityLMSName) %>%
  summarise(Total_Rooms_Sum = sum(Total_Rooms, na.rm = TRUE)) %>%
  ungroup()

# Join with Kneset25 and replace NA's in Total_Rooms with 0
Joined_Rooms_Kneset25 <- PropertiesRooms_Summary %>%
  mutate(lamas_code = as.numeric(lamas_code)) %>%
  right_join(Kneset25, by = c("lamas_code" = "Lamas_code")) %>%
  select(lamas_code, CityLMSName, Total_Rooms = Total_Rooms_Sum, first.party, first.party.percentage,
         second.party, second.party.percentage, third.party, third.party.percentage,
         forth.party, forth.party.percentage, coalition.support) %>%
  mutate(Total_Rooms = ifelse(is.na(Total_Rooms), 0, Total_Rooms))

# Print or use Joined_Rooms_Kneset25 as needed
Joined_Rooms_Kneset25

# # Prepare PropertiesRooms for model fitting
# Joined_Rooms_Kneset25 <- PropertiesRooms %>%
#   select(lamas_code, CityLMSName, Total_Rooms) %>%
#   mutate(lamas_code = as.numeric(lamas_code)) %>%
#   right_join(Kneset25, by = c("lamas_code" = "Lamas_code"))
# 
# Joined_Rooms_Kneset25 <- Joined_Rooms_Kneset25 %>%
#   select(lamas_code, CityLMSName, Total_Rooms, first.party, first.party.percentage, second.party, second.party.percentage, third.party, third.party.percentage, forth.party, forth.party.percentage, coalition.support) %>%
#   mutate(Total_Rooms = ifelse(is.na(Total_Rooms), 0, Total_Rooms))
# 
# Joined_Rooms_Kneset25
```


```{r, include=FALSE}
Joined_Vacant_Kneset25 <- VacantApt %>%
  select(CityLmsCode, CityLmsName) %>%
  group_by(CityLmsCode, CityLmsName) %>%
  summarise(Count_Vacant = n()) %>%
  left_join(Kneset25, by = c("CityLmsCode" = "Lamas_code"))

Joined_Vacant_Kneset25 <- Joined_Vacant_Kneset25 %>%
  select(CityLmsCode, CityLmsName, Count_Vacant, first.party, first.party.percentage, second.party, second.party.percentage, third.party, third.party.percentage, forth.party, forth.party.percentage, coalition.support)

Joined_Vacant_Kneset25
```


```{r}
# pearson correlation
Purchuses_Elections %>%
  dplyr::select(year, x3_rooms_apartments, x4_rooms_apartments, total_paid_in_Mil, coalition.support) %>%
  cor()
```


```{r, include=FALSE}
Purchuses_Elections
```


# Models - Purchases

```{r}
# linear regression: predict total amount spent per city by the coalition support feature
coalition_totPaid_model <- lm(total_paid_in_Mil ~ coalition.support, data = Purchuses_Elections)
summary(coalition_totPaid_model)
plot(Purchuses_Elections$coalition.support, Purchuses_Elections$total_paid_in_Mil, 
     xlab = "Coalition Support", ylab = "Total Paid (in Million)", 
     main = "Linear Regression: Total Paid vs Coalition Support")
abline(coalition_totPaid_model, col = "blue")
```

### not a good model - coeff of coalition.support isn't significant, low R-squared


```{r}
# bootstrapping the model
lm_model <- function(data, indices) {
  d <- data[indices, ] # allows boot to select sample
  fit <- lm(total_paid_in_Mil ~ coalition.support, data = d)
  return(coef(fit))
}

set.seed(123) # for reproducibility
boot_results <- boot(data = Purchuses_Elections, statistic = lm_model, R = 15000)
boot_results

boot.ci(boot_results, type = "perc", index = 1) # Intercept
boot.ci(boot_results, type = "perc", index = 2) # coalition.support
```

### no better after bootsrapping, coalition.support isn't significant


```{r}
# linear regression: predict total amount spent per city by the top four party percentage
percentage_totPaid_model <- lm(total_paid_in_Mil ~ first.party.percentage + second.party.percentage + third.party.percentage + forth.party.percentage + coalition.support, data = Purchuses_Elections)
summary(percentage_totPaid_model)
crPlots(percentage_totPaid_model)
```

### this model doesn't fit the data well as Std is very high and Adj R-squared is very low

```{r}
lm_model_percentage <- function(data, indices) {
  d <- data[indices, ] # allows boot to select sample
  fit <- lm(total_paid_in_Mil ~ first.party.percentage + second.party.percentage + third.party.percentage + forth.party.percentage + coalition.support, data = d)
  return(coef(fit))
}

set.seed(123) # for reproducibility
boot_results_percentage <- boot(data = Purchuses_Elections, statistic = lm_model_percentage, R = 15000)
boot_results_percentage

ci_intercept <- boot.ci(boot_results_percentage, type = "perc", index = 1)
ci_first_party <- boot.ci(boot_results_percentage, type = "perc", index = 2)
ci_second_party <- boot.ci(boot_results_percentage, type = "perc", index = 3)
ci_third_party <- boot.ci(boot_results_percentage, type = "perc", index = 4)
ci_forth_party <- boot.ci(boot_results_percentage, type = "perc", index = 5)
ci_coalition_support <- boot.ci(boot_results_percentage, type = "perc", index = 6)

# Print confidence intervals
list(ci_intercept = ci_intercept, ci_first_party = ci_first_party, ci_second_party = ci_second_party, 
     ci_third_party = ci_third_party, ci_forth_party = ci_forth_party, ci_coalition_support = ci_coalition_support)
```

### Though most of the predictors are statisticaly significt, the Std is very large indicating a poor model


```{r}
# poisson regression: predict log of num apartments purchased by coalition support
coalition_sumApt_model <- glm(sum_apartments ~ coalition.support, data = Purchuses_Elections, family = poisson)
summary(coalition_sumApt_model)

Purchuses_Elections$fitted_values <- predict(coalition_sumApt_model, type = "response")

# Plot the observed data
plot(Purchuses_Elections$coalition.support, Purchuses_Elections$sum_apartments,
     xlab = "Coalition Support", ylab = "Sum of Apartments",
     main = "Poisson Regression: Sum of Apartments vs Coalition Support",
     pch = 19, col = "blue")

# Add the fitted values line
lines(Purchuses_Elections$coalition.support, Purchuses_Elections$fitted_values, col = "red", lwd = 2)
```

### log(sum_apartments) = 2.33383 + 0.34278 * coalition.support  
### This model is statistacly significant showing that the government buys more apartments if you support the coalition


```{r}
# poisson regression: predict log of num apartments purchased by coalition support and party percentage
coalition_partyPer_sumApt_model <- glm(sum_apartments ~ first.party.percentage + second.party.percentage + third.party.percentage + forth.party.percentage + coalition.support, data = Purchuses_Elections, family = poisson)
summary(coalition_partyPer_sumApt_model)
crPlots(coalition_partyPer_sumApt_model)
```

### this model presents a better fit comparing to the previus model, we still see that higher coalition.support leads to more apartments purchases, but strong support of a party decreases that amount.


```{r}
# poisson regression: predict log of num apartments purchased by party percentage
partyPer_sumApt_model <- glm(sum_apartments ~ first.party.percentage + second.party.percentage + third.party.percentage + forth.party.percentage, data = Purchuses_Elections, family = poisson)
summary(partyPer_sumApt_model)
crPlots(partyPer_sumApt_model)
```

### this model is poorer (by AIC) than the previous model, yet shows that strong support in top 3 parties decreases the amount of apartments purchases


```{r}
Party_sum_model <- glm(sum_apartments ~ first.party.percentage + second.party.percentage + third.party.percentage + forth.party.percentage + coalition.support + first.party + second.party + third.party + forth.party, data = Purchuses_Elections, family = poisson)
summary(Party_sum_model)

# Compute residuals
residuals <- residuals(Party_sum_model, type = "deviance")

# Plot residuals against fitted values
ggplot(data.frame(Fitted = fitted(Party_sum_model), Residuals = residuals), aes(x = Fitted, y = Residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Residuals vs Fitted Values")

# Predict values from the model
predicted <- predict(Party_sum_model, type = "response")

# Plot predicted vs actual
ggplot(data.frame(Actual = Purchuses_Elections$sum_apartments, Predicted = predicted), aes(x = Actual, y = Predicted)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red") +
  labs(title = "Predicted vs Actual")
```

### this model fits the data better than all previous models (by AIC and residual deviance), this model strethen previous results that stronger coalition support increases the amount of purchased apartmnets. Yet, strong support of one party decreases the amount of purchased apartments.


# Models - PropertiesRooms

```{r, include=FALSE}
Joined_Rooms_Kneset25
```


```{r}
# linear regression: predict total amount of rooms per city by the coalition support feature
TotRooms_Coalition_model <- lm(Total_Rooms ~ coalition.support, data = Joined_Rooms_Kneset25)
  
summary(TotRooms_Coalition_model)
ggplot(Joined_Rooms_Kneset25, aes(x = coalition.support, y = Total_Rooms)) +
  geom_point() +  # Scatter plot of the data points
  geom_smooth(method = "lm", se = FALSE, color = "blue") +  # Regression line
  labs(x = "Coalition Support", y = "Total Rooms", title = "Linear Regression: Total Rooms vs Coalition Support")

# Compute residuals and fitted values
Joined_Rooms_Kneset25$residuals <- resid(TotRooms_Coalition_model)
Joined_Rooms_Kneset25$fitted <- fitted(TotRooms_Coalition_model)

# Residuals vs Fitted values plot
ggplot(Joined_Rooms_Kneset25, aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(x = "Fitted Values", y = "Residuals", title = "Residuals vs Fitted Values")

# Histogram of residuals
ggplot(Joined_Rooms_Kneset25, aes(x = residuals)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black", alpha = 0.7) +
  labs(x = "Residuals", y = "Frequency", title = "Histogram of Residuals")

# Q-Q plot of residuals
qqnorm(Joined_Rooms_Kneset25$residuals)
qqline(Joined_Rooms_Kneset25$residuals, col = "red", lwd = 2)
```

### Though the model is statisticaly significant, it has poor R-squared


```{r}
# linear regression: predict total amount of rooms per city by the coalition support and party percentage
TotRooms_Coalition_partyPer_model <- lm(Total_Rooms ~ coalition.support + first.party.percentage + second.party.percentage + third.party.percentage + forth.party.percentage, data = Joined_Rooms_Kneset25)
summary(TotRooms_Coalition_partyPer_model)

predictions <- augment(TotRooms_Coalition_partyPer_model, data = Joined_Rooms_Kneset25)
# Actual vs Predicted values plot
ggplot(predictions, aes(x = Total_Rooms, y = .fitted)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red") +
  labs(x = "Actual Values", y = "Predicted Values", title = "Predicted vs Actual Values")

# Residuals vs Fitted values plot
ggplot(predictions, aes(x = .fitted, y = .resid)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(x = "Fitted Values", y = "Residuals", title = "Residuals vs Fitted Values")
```

### better than the previous model, yet poor adjusted R-squared


```{r}
# poisson regression: predict log of num apartments available by coalition support
coalition_totRooms_model <- glm(Total_Rooms ~ coalition.support, data = Joined_Rooms_Kneset25, family = poisson)
summary(coalition_totRooms_model)

# Generate predictions from the model
predictions <- Joined_Rooms_Kneset25 %>%
  mutate(predicted_Total_Rooms = predict(coalition_totRooms_model, type = "response"))

# Plot the actual data and the predicted values
ggplot(predictions, aes(x = coalition.support, y = Total_Rooms)) +
  geom_point(alpha = 0.5) +  # Scatter plot of actual data points
  geom_line(aes(y = predicted_Total_Rooms), color = "blue", size = 1) +  # Line plot of predicted values
  labs(x = "Coalition Support", y = "Total Rooms", 
       title = "Poisson Regression: Total Rooms vs Coalition Support") +
  theme_minimal()
```

### very large AIC comparing to purchased models


```{r}
# poisson regression: predict log of num apartments available by coalition support and party percentage
coalition_totRooms_partyPer_model <- glm(Total_Rooms ~ coalition.support + first.party.percentage + second.party.percentage + third.party.percentage + forth.party.percentage, family = poisson, data = Joined_Rooms_Kneset25)
summary(coalition_totRooms_partyPer_model)
```

### better AIC than previous model, no better than purchased models


